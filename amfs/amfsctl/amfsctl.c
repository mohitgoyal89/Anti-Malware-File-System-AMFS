/*
 * Copyright (c) 2015 Mohit Goyal
 * Copyright (c) 2015-2106 Stony Brook University
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */

/*
 * amfsctl is a user program which will invoke the ioctl system
 * call to print the list of virus patterns, add new patterns or remove
 * existing virus patterns
 */

#include "amfsctl.h"

/**
 * options string to get user option
 **/
static char *opt = "la:r:h";

/**
 * main function which will invoke the ioctl system call
 **/
int main(int argc, char *argv[])
{
	int op, fd, errno = 0;
	char *mnt_pt = NULL, *pattern = NULL;
	char *buf = NULL;

	/* option flags used for the user options */
	int lflag = 0, aflag = 0;
	int rflag = 0, hflag = 0;

	while ((op = getopt(argc, argv, opt)) != -1) {
		switch (op) {
		/* option 'l' to list patterns */
		case 'l':
			lflag = 1;
			mnt_pt = argv[2];
			break;

		/* option 'a' to add new pattern */
		case 'a':
			aflag = 1;
			mnt_pt = argv[3];
			pattern = optarg;
			break;

		/* option 'r' to remove an existing pattern */
		case 'r':
			rflag = 1;
			mnt_pt = argv[3];
			pattern = optarg;
			break;

		/* option 'h' for help */
		case 'h':
			hflag = 1;
			break;

		default:
			errno = -1;
			printf("Error: Wrong options entered, use option -h for help\n");
			goto out;
		}
	}

	/* printing the help message */
	if (hflag) {
		printf("usage:	amfsctl is used for display existing virus patterns, add new pattern or remove pattern from pattern.db\n");
		printf("	Syntax: ./amfsctl -l /mnt/amfs\n");
		printf("	[-l: list patterns]  [-a: add new pattern]  [-r: remove pattern]\n");
		exit(0);
	}

	/* check whether both add and remove pattern option are provided by user */
	if ((aflag == 1) && (rflag == 1)) {
		errno = -1;
		printf("Error: Both add and remove pattern options are given\n");
		goto out;
	}

	/* check for correct user arguments are given */
	if (argc < 3) {
		errno = -1;
		printf("Error: Syntax should be ./amfsctl -l /mnt/amfs\n");
		goto out;
	} else if (argc - optind < 1) {
		errno = -1;
		printf("Error: Path argument missing\n");
		goto out;
	}

	#ifdef DEBUG
	printf("mount point %s\n", mnt_pt);
	printf("pattern %s\n", pattern);
	#endif

	fd = open(mnt_pt, O_RDONLY);
	/* check for proper file descriptor */
	if (fd < 0) {
		errno = fd;
		printf("Error: Fail to open the file\n");
		goto out;
	}

	/* allocating memory for the buffer */
	buf = (char *) malloc(SIZE);
	if (buf == NULL) {
		printf("Error: Memory allocation fail for the buffer\n");
		errno = -12;
		goto out;
	}
	memset(buf, 0, SIZE);

	/* check for the list option */
	if (lflag == 1) {
		/* invoking ioctl system call for displaying pattern list */
		errno = ioctl(fd, R_IOCTL, buf);
		if (errno < 0) {
			printf("Error: Fail to read the file\n");
			goto out;
		}
		printf("Virus Patterns:\n%s\n", buf);
	}

	/* check for the add option */
	if (aflag == 1) {
		if (strlen(pattern) == 0) {
			errno = -1;
			printf("Error: Pattern to be added can not be of zero length\n");
			goto out;
		}

		/* invoking ioctl system call for add new pattern to list */
		errno = ioctl(fd, W_IOCTL, pattern);
		if (errno == 0) {
			printf("Pattern successfully added in pattern.db\n");
			goto out;
		} else if (errno < 0) {
			printf("Error: Fail to add pattern in pattern.db\n");
			goto out;
		} else if (errno == 1) {
			printf("Error: 1 Pattern to be added can not be of zero length\n");
			goto out;
		} else if (errno == 2) {
			printf("Error: Pattern already exists in pattern.db\n");
			goto out;
		}
	}

	/* check for the remove option */
	if (rflag == 1) {
		if (strlen(pattern) == 0) {
			errno = -1;
			printf("Error: Pattern to be removed can not be of zero length\n");
			goto out;
		}

		/* invoking ioctl system call for removing pattern from list */
		errno = ioctl(fd, WR_IOCTL, pattern);
		if (errno == 0) {
			printf("Pattern successfully removed from pattern.db\n");
			goto out;
		} else if (errno < 0) {
			printf("Error: Fail to remove pattern from pattern.db\n");
			goto out;
		} else if (errno == 1) {
			printf("Error: 1 Pattern to be removed can not be of zero length\n");
			goto out;
		} else if (errno == 2) {
			printf("Error: Pattern to be removed does not exist in pattern.db\n");
			goto out;
		}
	}
	close(fd);
	exit(errno);

out:
	/* memory deallocation */
	if (buf != NULL)
		free(buf);
	close(fd);
	exit(errno);
}
