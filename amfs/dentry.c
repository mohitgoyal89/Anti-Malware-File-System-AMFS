/*
 * Copyright (c) 2015 Mohit Goyal
 * Copyright (c) 2015-2106 Stony Brook University
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */

#include "amfs.h"

/*
 * returns: -ERRNO if error (returned to user)
 *          0: tell VFS to invalidate dentry
 *          1: dentry is valid
 */
static int amfs_d_revalidate(struct dentry *dentry, unsigned int flags)
{
	struct path lower_path;
	struct dentry *lower_dentry;
	int err = 1;

	int rc_name = 0, rc_ver = 0;
	int amfs_xattr_ver, ver_no;
	char *amfs_xattr_val = "";
	struct super_block *amfs_sb;

	if (flags & LOOKUP_RCU)
		return -ECHILD;

	amfs_get_lower_path(dentry, &lower_path);
	lower_dentry = lower_path.dentry;

	/* check for the bad marked files and invalidate it from dcache
	amfs_sb = dentry->d_inode->i_sb;
	ver_no = AMFS_SB(amfs_sb)->ver_no;

	rc_name = dentry->d_inode->i_op->getxattr(dentry, AMFS_XATTR_NAME,
				amfs_xattr_val, AMFS_XATTR_SIZE);
	rc_ver = dentry->d_inode->i_op->getxattr(dentry, AMFS_XATTR_VER,
				&amfs_xattr_ver, sizeof(amfs_xattr_ver));

	#ifdef DEBUG
	printk("amfs_d_revalidate amfs_xattr_val: %s\n", amfs_xattr_val);
	printk("amfs_d_revalidate amfs_xattr_ver: %d\n", amfs_xattr_ver);
	#endif

	 checking attributes of files if marked bad and version matched
	if ((strncmp(amfs_xattr_val, AMFS_XATTR_BAD, AMFS_XATTR_SIZE) == 0) &&
					(amfs_xattr_ver == ver_no)) {
		printk("Virus pattern found while amfs revalidate\n");
		err = 0;
		goto out;
	}*/

	if (!(lower_dentry->d_flags & DCACHE_OP_REVALIDATE))
		goto out;
	err = lower_dentry->d_op->d_revalidate(lower_dentry, flags);
out:
	amfs_put_lower_path(dentry, &lower_path);
	return err;
}

static void amfs_d_release(struct dentry *dentry)
{
	/* release and reset the lower paths */
	amfs_put_reset_lower_path(dentry);
	free_dentry_private_data(dentry);
	return;
}

const struct dentry_operations amfs_dops = {
	.d_revalidate	= amfs_d_revalidate,
	.d_release	= amfs_d_release,
};
